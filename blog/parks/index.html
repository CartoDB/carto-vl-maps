<!DOCTYPE html>
<html>

  <head>
    <title>Parks | CARTO</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700|Open+Sans:300,400,600" rel="stylesheet">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://libs.cartocdn.com/carto.js/v4.1.11/carto.min.js"></script>
  </head>

  <style>
    html,
    body,
    #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;

    }

    div#searchbox {
        background-color: #d2eaef;
        opacity: 0.8;
        position: absolute;
        top: 10px;
        left: 50px;
        width: auto;
        height: auto;
        padding: 10px;
        display: block;
        z-index: 9000;

    }

    div#searchbox input {
        width: 200px;
    }

    div#results {
        background: #FFF;
    }

    </style>

  <body>
    <div id="map"></div>
    <div id="searchbox">
      <select id="selectDrop">
        <option selected value="">Select city</option>
      </select> 
        
      <select id="selectParam"> 
        <option value="itx1_00_area" selected>Buffer (R = 1&nbsp;km)</option>
        <option value="grav1_00">Gravity (Î± = 1)</option>
        <option value="dsteps_fit">GEE FE Fit</option>
        <option value="distance_fit">GEE Dist. Fit</option>
      </select>
    
    </div>

    <script>

      const map = L.map('map').setView([40.70979201243498, -73.97781372070314], 10);

        //disable scroll wheel zoom

      map.scrollWheelZoom.disable();

       // add basemap

      L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 18
      }).addTo(map);

      // CARTO client

      const client = new carto.Client({
        apiKey: 'default_public',
        username: 'mballesteros'
      });
          
      // Insert layer cities
         
      const source = new carto.source.SQL(`SELECT * FROM mballesteros.parksrec WHERE city='New York'`);
      const style = new carto.style.CartoCSS(
        `#layer {
        polygon-fill: ramp([grav1_00], (#d3f2a3, #82d091, #4c9b82, #19696f, #074050), quantiles);}
        #layer::outline {
        line-width: 1;
        line-color: #FFFFFF;
        line-opacity: 0.5;
          }
      `);
      const layer = new carto.layer.Layer(source, style);

      client.addLayer(layer);
      client.getLeafletLayer().addTo(map);

      function setCity(cityName) { 
        source.setQuery (`SELECT * FROM mballesteros.parksrec WHERE city='${cityName}'`)
      }

      document.getElementById('selectDrop').addEventListener("change", function (e) {
        setCity(e.target.value)
      })

      function getCities(){
        return fetch(
          `https://mballesteros.carto.com/api/v2/sql?q=SELECT distinct city FROM mballesteros.parksrec`
              ).then((resp) => resp.json())
              .then((response) => {
              return response.rows.map(function(r){  
                option = document.createElement("option")
                option.setAttribute("value", r.city)
                option.textContent = r.city
                document.getElementById("selectDrop").appendChild(option);
            });
          }).catch((error) => {
            console.log(error)
        })      
      }
      getCities();


                    
      function setParam(param) {
        
        style.setContent(`
          #layer {
            polygon-fill: ramp([${param}], (#E4F1E1, #9CCDC1, #63A6A0, #337F7F, #0D585F), quantiles);
            }
            #layer::outline {
            line-width: 1;
            line-color: #FFFFFF;
            line-opacity: 0.5;
            } `);
      }
      
      document.getElementById('selectParam').addEventListener("change", function (e) {
        setParam(e.target.value)
      })

</script>
